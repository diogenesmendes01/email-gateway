# Plano de Migra√ß√£o: AWS SES ‚Üí ESP Self-Hosted

> **Data de Cria√ß√£o:** 30 de Outubro de 2025
> **Status:** Planejamento
> **Autor:** An√°lise T√©cnica Completa

---

## üìã Sum√°rio Executivo

Este documento mapeia **todas as mudan√ßas e adapta√ß√µes** necess√°rias para transformar o `email-gateway` atual (dependente de AWS SES) em um **ESP (Email Service Provider) self-hosted** completo, mantendo AWS SES como uma op√ß√£o toggle (ativado/desativado).

### Objetivos Principais

1. **AWS SES como Toggle**: Manter SES como op√ß√£o configur√°vel (on/off)
2. **ESP Self-Hosted**: Criar driver SMTP/API pr√≥prio com MTA (Postal/Mailu/Haraka)
3. **Funcionalidades Avan√ßadas**: Implementar todos os recursos de um ESP profissional

---

## üîç An√°lise do Estado Atual

### Arquitetura Existente

**Stack Tecnol√≥gico:**
- **API**: NestJS + TypeScript
- **Worker**: Node.js + BullMQ
- **Queue**: Redis (BullMQ)
- **Database**: PostgreSQL + Prisma ORM
- **Email Provider**: AWS SES (hard-coded)
- **Webhooks**: AWS SNS ‚Üí SES Events

**Depend√™ncias do AWS SES:**
1. `SESService` (`apps/worker/src/services/ses.service.ts`) - envio direto
2. `SESEventProcessorService` - processamento de bounces/complaints/delivery via SNS
3. `SESWebhookService` - recebimento de webhooks SNS
4. `DomainManagementService` - verifica√ß√£o de dom√≠nios via AWS SES API
5. Configura√ß√£o SES (`apps/worker/src/config/ses.config.ts`)

**Pontos Fortes Existentes:**
- ‚úÖ Sistema de filas robusto (BullMQ + Redis)
- ‚úÖ Retry com backoff exponencial
- ‚úÖ Blocklist (hard bounce + complaints)
- ‚úÖ M√©tricas e monitoramento (Prometheus)
- ‚úÖ Multi-tenant (por Company)
- ‚úÖ Rate limiting b√°sico
- ‚úÖ Domain management e DKIM
- ‚úÖ Warm-up configuration

---

## üéØ Escopo das Mudan√ßas

### Fase 1: AWS SES como Toggle ‚úÖ
- Abstrair `SESService` para interface `IEmailDriver`
- Criar sistema de configura√ß√£o por provider
- Manter compatibilidade 100% com c√≥digo existente

### Fase 2: Driver SMTP/API Self-Hosted üöÄ
- Implementar driver Postal/Mailu/Haraka
- IP pools (transacional, marketing, dedicado)
- Rate limit por MX (Gmail, Outlook, Yahoo)
- Envelope-From dedicado por dom√≠nio

### Fase 3: Webhooks & Ingest üì•
- Parser DSN (Delivery Status Notification)
- Parser ARF (Abuse Reporting Format)
- Processamento de opens/clicks
- Sistema de supress√£o avan√ßado

### Fase 4: Onboarding & DNS Automation üåê
- Gera√ß√£o autom√°tica de DKIM 2048-bit
- Checklist DNS (DKIM/SPF/Return-Path/Tracking)
- Verifica√ß√£o autom√°tica de registros DNS
- Return-Path dedicado por cliente

### Fase 5: M√©tricas & Guardrails üìä
- Dashboard por tenant/dom√≠nio
- Pausar envios se bounce ‚â•2% ou complaint ‚â•0,1%
- Warm-up autom√°tico
- Postmaster/DMARC ingest (Gmail Postmaster, MS SNDS)

---

## üì¶ 1. MUDAN√áAS NO BANCO DE DADOS

### 1.1 Novos Enums

```prisma
// Provider de email
enum EmailProvider {
  AWS_SES
  POSTAL_SMTP
  POSTAL_API
  MAILU_SMTP
  HARAKA_API
  CUSTOM_SMTP
}

// Tipos de IP pool
enum IPPoolType {
  TRANSACTIONAL  // Alta prioridade, 2FA, recibos
  MARKETING      // Newsletters, campanhas
  DEDICATED      // IP dedicado por cliente
  SHARED         // Pool compartilhado
}

// Tipos de rate limit
enum RateLimitScope {
  MX_DOMAIN      // Por MX (gmail.com, outlook.com)
  CUSTOMER_DOMAIN // Por dom√≠nio do cliente
  IP_ADDRESS     // Por IP de envio
  GLOBAL         // Global do sistema
}

// Tipos de supress√£o
enum SuppressionReason {
  HARD_BOUNCE
  SOFT_BOUNCE
  SPAM_COMPLAINT
  UNSUBSCRIBE
  ROLE_ACCOUNT    // admin@, info@, etc
  BAD_DOMAIN
  MANUAL
}

// Status de onboarding de dom√≠nio
enum DomainOnboardingStatus {
  DNS_PENDING
  DNS_CONFIGURED
  DKIM_PENDING
  DKIM_VERIFIED
  SPF_PENDING
  SPF_VERIFIED
  RETURN_PATH_PENDING
  RETURN_PATH_VERIFIED
  WARMUP_IN_PROGRESS
  PRODUCTION_READY
  FAILED
}
```

### 1.2 Tabela: `email_providers` (Nova)

```prisma
model EmailProvider {
  id            String   @id @default(cuid())
  companyId     String?  @map("company_id") // null = global
  provider      EmailProvider @default(AWS_SES)
  isActive      Boolean  @default(true) @map("is_active")
  priority      Int      @default(0) // 0 = mais alta
  
  // Configura√ß√£o gen√©rica (JSON)
  config        Json     // { host, port, user, pass, api_key, etc }
  
  // Limites por provider
  dailyLimit    Int?     @map("daily_limit")
  hourlyLimit   Int?     @map("hourly_limit")
  
  // Tracking
  sentToday     Int      @default(0) @map("sent_today")
  sentThisHour  Int      @default(0) @map("sent_this_hour")
  lastReset     DateTime @default(now()) @map("last_reset")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  company       Company? @relation(fields: [companyId], references: [id])
  
  @@unique([companyId, provider])
  @@index([isActive, priority])
  @@map("email_providers")
}
```

### 1.3 Tabela: `ip_pools` (Nova)

```prisma
model IPPool {
  id            String      @id @default(cuid())
  name          String      @db.VarChar(100)
  type          IPPoolType
  ipAddresses   String[]    @map("ip_addresses") // IPs do pool
  isActive      Boolean     @default(true) @map("is_active")
  
  // Limites
  dailyLimit    Int?        @map("daily_limit")
  hourlyLimit   Int?        @map("hourly_limit")
  
  // Tracking
  sentToday     Int         @default(0) @map("sent_today")
  reputation    Float       @default(100.0) // 0-100
  
  // Warm-up
  warmupEnabled Boolean     @default(false) @map("warmup_enabled")
  warmupConfig  Json?       @map("warmup_config")
  
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  @@index([type, isActive])
  @@map("ip_pools")
}
```

### 1.4 Tabela: `rate_limits` (Nova)

```prisma
model RateLimit {
  id            String          @id @default(cuid())
  scope         RateLimitScope
  target        String          @db.VarChar(253) // MX domain, IP, etc
  
  // Limites
  perMinute     Int?            @map("per_minute")
  perHour       Int?            @map("per_hour")
  perDay        Int?            @map("per_day")
  
  // Janelas deslizantes (Redis)
  lastMinute    Int             @default(0) @map("last_minute")
  lastHour      Int             @default(0) @map("last_hour")
  lastDay       Int             @default(0) @map("last_day")
  
  // Tracking
  lastReset     DateTime        @default(now()) @map("last_reset")
  
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  
  @@unique([scope, target])
  @@index([scope, target, lastReset])
  @@map("rate_limits")
}
```

### 1.5 Tabela: `suppressions` (Nova - Substitui `recipient_blocklist`)

```prisma
model Suppression {
  id            String              @id @default(cuid())
  companyId     String?             @map("company_id") // null = global
  email         String              @db.VarChar(254)
  domain        String?             @db.VarChar(253)
  reason        SuppressionReason
  
  // Metadata
  source        String?             @db.VarChar(64) // bounce, complaint, manual
  bounceType    String?             @map("bounce_type") @db.VarChar(32)
  diagnosticCode String?            @map("diagnostic_code") @db.Text
  
  // Timing
  suppressedAt  DateTime            @default(now()) @map("suppressed_at")
  expiresAt     DateTime?           @map("expires_at") // Para soft bounces
  
  // Relations
  company       Company?            @relation(fields: [companyId], references: [id])
  
  @@unique([companyId, email])
  @@index([reason, suppressedAt])
  @@index([domain, reason])
  @@map("suppressions")
}
```

### 1.6 Tabela: `dns_records` (Nova)

```prisma
model DNSRecord {
  id            String                    @id @default(cuid())
  domainId      String                    @map("domain_id")
  recordType    String                    @db.VarChar(10) // TXT, CNAME, MX
  name          String                    @db.VarChar(253)
  value         String                    @db.Text
  priority      Int?
  isVerified    Boolean                   @default(false) @map("is_verified")
  lastChecked   DateTime?                 @map("last_checked")
  
  createdAt     DateTime                  @default(now()) @map("created_at")
  updatedAt     DateTime                  @updatedAt @map("updated_at")
  
  // Relations
  domain        Domain                    @relation(fields: [domainId], references: [id], onDelete: Cascade)
  
  @@index([domainId, recordType])
  @@map("dns_records")
}
```

### 1.7 Tabela: `domain_onboarding` (Nova)

```prisma
model DomainOnboarding {
  id            String                    @id @default(cuid())
  domainId      String                    @unique @map("domain_id")
  status        DomainOnboardingStatus    @default(DNS_PENDING)
  
  // Checklist items
  dkimGenerated Boolean                   @default(false) @map("dkim_generated")
  dkimPublic    String?                   @db.Text @map("dkim_public")
  dkimPrivate   String?                   @db.Text @map("dkim_private") // ENCRYPTED
  dkimSelector  String?                   @db.VarChar(63) @map("dkim_selector")
  
  spfRecord     String?                   @db.VarChar(512) @map("spf_record")
  returnPath    String?                   @db.VarChar(253) @map("return_path")
  trackingDomain String?                  @db.VarChar(253) @map("tracking_domain")
  
  // Auto-verification
  lastCheckAt   DateTime?                 @map("last_check_at")
  nextCheckAt   DateTime?                 @map("next_check_at")
  checkAttempts Int                       @default(0) @map("check_attempts")
  
  // Production readiness
  readyForProduction Boolean                @default(false) @map("ready_for_production")
  productionApprovedAt DateTime?            @map("production_approved_at")
  productionApprovedBy String?              @db.VarChar(128) @map("production_approved_by")
  
  createdAt     DateTime                  @default(now()) @map("created_at")
  updatedAt     DateTime                  @updatedAt @map("updated_at")
  
  // Relations
  domain        Domain                    @relation(fields: [domainId], references: [id], onDelete: Cascade)
  
  @@map("domain_onboarding")
}
```

### 1.8 Tabela: `email_tracking` (Nova)

```prisma
model EmailTracking {
  id            String   @id @default(cuid())
  emailLogId    String   @map("email_log_id")
  trackingId    String   @unique @db.VarChar(64) @map("tracking_id")
  
  // Events
  openedAt      DateTime? @map("opened_at")
  openCount     Int       @default(0) @map("open_count")
  clickedAt     DateTime? @map("clicked_at")
  clickCount    Int       @default(0) @map("click_count")
  
  // Click details
  clickedUrls   Json?     @map("clicked_urls") // Array de { url, timestamp }
  
  // User agent
  userAgent     String?   @db.Text @map("user_agent")
  ipAddress     String?   @db.VarChar(45) @map("ip_address")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  
  // Relations
  emailLog      EmailLog  @relation(fields: [emailLogId], references: [id], onDelete: Cascade)
  
  @@index([emailLogId])
  @@index([trackingId])
  @@map("email_tracking")
}
```

### 1.9 Tabela: `reputation_metrics` (Nova)

```prisma
model ReputationMetric {
  id              String   @id @default(cuid())
  companyId       String?  @map("company_id") // null = global
  domainId        String?  @map("domain_id")
  ipPoolId        String?  @map("ip_pool_id")
  
  date            DateTime @db.Date
  
  // M√©tricas
  sent            Int      @default(0)
  delivered       Int      @default(0)
  bounced         Int      @default(0)
  bouncedHard     Int      @default(0) @map("bounced_hard")
  bouncedSoft     Int      @default(0) @map("bounced_soft")
  complained      Int      @default(0)
  opened          Int      @default(0)
  clicked         Int      @default(0)
  
  // Taxas calculadas
  bounceRate      Float    @default(0) @map("bounce_rate")
  complaintRate   Float    @default(0) @map("complaint_rate")
  openRate        Float    @default(0) @map("open_rate")
  clickRate       Float    @default(0) @map("click_rate")
  
  // Reputa√ß√£o
  reputationScore Float    @default(100) @map("reputation_score")
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  company         Company?  @relation(fields: [companyId], references: [id])
  domain          Domain?   @relation(fields: [domainId], references: [id])
  ipPool          IPPool?   @relation(fields: [ipPoolId], references: [id])
  
  @@unique([companyId, domainId, ipPoolId, date])
  @@index([date, companyId])
  @@map("reputation_metrics")
}
```

### 1.10 Atualiza√ß√µes em Tabelas Existentes

**`companies`:**
```prisma
// Adicionar campos
providerConfig    Json?   @map("provider_config") // Config espec√≠fica por empresa
defaultProviderId String? @map("default_provider_id")
defaultIPPoolId   String? @map("default_ip_pool_id")
```

**`domains`:**
```prisma
// Adicionar campos
onboardingStatus  DomainOnboardingStatus @default(DNS_PENDING) @map("onboarding_status")
returnPathDomain  String?                @db.VarChar(253) @map("return_path_domain")
trackingDomain    String?                @db.VarChar(253) @map("tracking_domain")

// Relations
dnsRecords        DNSRecord[]
onboarding        DomainOnboarding?
reputationMetrics ReputationMetric[]
```

**`email_logs`:**
```prisma
// Adicionar campos
provider          EmailProvider?         // Qual provider foi usado
ipPoolId          String?                @map("ip_pool_id")
ipAddress         String?                @db.VarChar(45) @map("ip_address")
dsnReport         Json?                  @map("dsn_report") // DSN completo
arfReport         Json?                  @map("arf_report") // ARF completo
trackingId        String?                @unique @map("tracking_id")

// Relations
tracking          EmailTracking?
```

---

## üèóÔ∏è 2. MUDAN√áAS NA ARQUITETURA

### 2.1 Nova Estrutura de Drivers

```
apps/worker/src/
‚îú‚îÄ‚îÄ drivers/
‚îÇ   ‚îú‚îÄ‚îÄ base/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email-driver.interface.ts       // Interface base
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ email-driver-result.ts          // Types compartilhados
‚îÇ   ‚îú‚îÄ‚îÄ aws-ses/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ses-driver.ts                   // Implementa√ß√£o SES (refatorado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ses-config.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ses-event-parser.ts
‚îÇ   ‚îú‚îÄ‚îÄ postal/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ postal-smtp-driver.ts           // Postal via SMTP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ postal-api-driver.ts            // Postal via API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ postal-webhook-parser.ts        // Parser de webhooks Postal
‚îÇ   ‚îú‚îÄ‚îÄ mailu/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mailu-smtp-driver.ts            // Mailu via SMTP
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mailu-webhook-parser.ts
‚îÇ   ‚îú‚îÄ‚îÄ haraka/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ haraka-api-driver.ts            // Haraka via API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ haraka-webhook-parser.ts
‚îÇ   ‚îî‚îÄ‚îÄ driver-factory.ts                    // Factory para criar drivers
```

### 2.2 Interface `IEmailDriver` (Base)

```typescript
interface IEmailDriver {
  // Envio
  sendEmail(job: EmailSendJobData, config: DriverConfig): Promise<SendResult>;
  
  // Valida√ß√£o
  validateConfig(): Promise<boolean>;
  
  // Quota/Limits
  getQuota(): Promise<QuotaInfo | null>;
  
  // DNS/Dom√≠nios
  verifyDomain(domain: string): Promise<DomainVerification>;
  
  // IP Pools (se suportado)
  getIPPools?(): Promise<IPPool[]>;
  selectIPPool?(job: EmailSendJobData): Promise<string | null>;
}

interface SendResult {
  success: boolean;
  messageId?: string;
  provider: EmailProvider;
  ipAddress?: string;
  error?: MappedError;
}

interface DriverConfig {
  provider: EmailProvider;
  host?: string;
  port?: number;
  secure?: boolean;
  auth?: {
    user: string;
    pass: string;
  };
  apiKey?: string;
  region?: string;
  ipPoolId?: string;
  [key: string]: any;
}
```

### 2.3 Driver Factory

```typescript
class DriverFactory {
  static create(provider: EmailProvider, config: DriverConfig): IEmailDriver {
    switch (provider) {
      case EmailProvider.AWS_SES:
        return new SESDriver(config);
      case EmailProvider.POSTAL_SMTP:
        return new PostalSMTPDriver(config);
      case EmailProvider.POSTAL_API:
        return new PostalAPIDriver(config);
      case EmailProvider.MAILU_SMTP:
        return new MailuSMTPDriver(config);
      case EmailProvider.HARAKA_API:
        return new HarakaAPIDriver(config);
      default:
        throw new Error(`Unsupported provider: ${provider}`);
    }
  }
}
```

### 2.4 Novo Servi√ßo: `EmailDriverService`

```typescript
// apps/worker/src/services/email-driver.service.ts
class EmailDriverService {
  async sendEmailWithFallback(
    job: EmailSendJobData,
    companyId: string
  ): Promise<SendResult> {
    // 1. Obter providers configurados (prioridade)
    const providers = await this.getActiveProviders(companyId);
    
    // 2. Tentar cada provider at√© sucesso
    for (const provider of providers) {
      try {
        const driver = DriverFactory.create(provider.provider, provider.config);
        const result = await driver.sendEmail(job, provider.config);
        
        if (result.success) {
          await this.recordSuccess(provider.id, job);
          return result;
        }
      } catch (error) {
        await this.recordFailure(provider.id, error);
        // Continue para pr√≥ximo provider
      }
    }
    
    throw new Error('All providers failed');
  }
}
```

---

## üîß 3. MUDAN√áAS NA API

### 3.1 Novos Endpoints

#### **Email Providers**
```
POST   /v1/admin/providers              # Criar provider
GET    /v1/admin/providers              # Listar providers
PUT    /v1/admin/providers/:id          # Atualizar provider
DELETE /v1/admin/providers/:id          # Remover provider
POST   /v1/admin/providers/:id/test     # Testar provider
```

#### **IP Pools**
```
POST   /v1/admin/ip-pools               # Criar IP pool
GET    /v1/admin/ip-pools               # Listar IP pools
PUT    /v1/admin/ip-pools/:id           # Atualizar IP pool
GET    /v1/admin/ip-pools/:id/metrics   # M√©tricas do pool
```

#### **Rate Limits**
```
POST   /v1/admin/rate-limits            # Criar rate limit
GET    /v1/admin/rate-limits            # Listar rate limits
PUT    /v1/admin/rate-limits/:id        # Atualizar rate limit
```

#### **Suppressions**
```
POST   /v1/suppressions                 # Adicionar supress√£o
GET    /v1/suppressions                 # Listar supress√µes
DELETE /v1/suppressions/:id             # Remover supress√£o
POST   /v1/suppressions/import          # Importar lista
POST   /v1/suppressions/check           # Verificar email
```

#### **Domain Onboarding**
```
POST   /v1/domains/:id/onboarding/start         # Iniciar onboarding
GET    /v1/domains/:id/onboarding/status        # Status do onboarding
POST   /v1/domains/:id/onboarding/verify        # Verificar DNS
POST   /v1/domains/:id/onboarding/generate-dkim # Gerar par DKIM
GET    /v1/domains/:id/onboarding/checklist     # Checklist completo
```

#### **Reputation & Metrics**
```
GET    /v1/reputation                           # Reputa√ß√£o da empresa
GET    /v1/reputation/domain/:id                # Reputa√ß√£o do dom√≠nio
GET    /v1/reputation/alerts                    # Alertas ativos
GET    /v1/metrics/dashboard                    # Dashboard completo
GET    /v1/metrics/postmaster                   # Gmail Postmaster (se configurado)
```

#### **Tracking**
```
GET    /track/open/:trackingId                  # Pixel de abertura
GET    /track/click/:trackingId/:linkId         # Redirect de clique
```

### 3.2 Novos Servi√ßos

```
apps/api/src/modules/
‚îú‚îÄ‚îÄ provider/
‚îÇ   ‚îú‚îÄ‚îÄ provider.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ provider.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îú‚îÄ‚îÄ ip-pool/
‚îÇ   ‚îú‚îÄ‚îÄ ip-pool.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ ip-pool.service.ts
‚îú‚îÄ‚îÄ rate-limit/
‚îÇ   ‚îú‚îÄ‚îÄ rate-limit.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ rate-limit.service.ts
‚îú‚îÄ‚îÄ suppression/
‚îÇ   ‚îú‚îÄ‚îÄ suppression.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ suppression.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ import/
‚îú‚îÄ‚îÄ onboarding/
‚îÇ   ‚îú‚îÄ‚îÄ onboarding.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ onboarding.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ dkim-generator.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ dns-verifier.service.ts
‚îú‚îÄ‚îÄ reputation/
‚îÇ   ‚îú‚îÄ‚îÄ reputation.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ reputation.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ postmaster.service.ts
‚îî‚îÄ‚îÄ tracking/
    ‚îú‚îÄ‚îÄ tracking.controller.ts
    ‚îî‚îÄ‚îÄ tracking.service.ts
```

---

## ‚öôÔ∏è 4. MUDAN√áAS NO WORKER

### 4.1 Novos Servi√ßos

#### **DSN Parser Service**
```typescript
// apps/worker/src/services/dsn-parser.service.ts
class DSNParserService {
  parseDSN(rawDSN: string): DSNReport {
    // Parse RFC 3464 Delivery Status Notification
    // Extrai: action, status, diagnostic-code, etc
  }
  
  classifyBounce(dsn: DSNReport): {
    type: 'hard' | 'soft' | 'transient';
    reason: string;
    shouldSuppress: boolean;
  }
}
```

#### **ARF Parser Service**
```typescript
// apps/worker/src/services/arf-parser.service.ts
class ARFParserService {
  parseARF(rawARF: string): ARFReport {
    // Parse RFC 5965 Abuse Reporting Format
    // Extrai: feedback-type, user-agent, source-ip, etc
  }
  
  extractComplaint(arf: ARFReport): ComplaintInfo {
    // Extrai informa√ß√µes relevantes de spam complaint
  }
}
```

#### **MX Rate Limiter Service**
```typescript
// apps/worker/src/services/mx-rate-limiter.service.ts
class MXRateLimiterService {
  async checkLimit(recipientEmail: string): Promise<boolean> {
    const mxDomain = this.extractMXDomain(recipientEmail);
    const limit = await this.getMXLimit(mxDomain);
    
    return await this.rateLimiter.checkAndIncrement(
      `mx:${mxDomain}`,
      limit
    );
  }
  
  private getMXLimit(mxDomain: string): RateLimit {
    // Gmail: 20 msgs/segundo
    // Outlook: 10 msgs/segundo
    // Yahoo: 5 msgs/segundo
    // Default: 1 msg/segundo
  }
}
```

#### **Return-Path Service**
```typescript
// apps/worker/src/services/return-path.service.ts
class ReturnPathService {
  generateReturnPath(
    recipientEmail: string,
    companyDomain: string
  ): string {
    // bounce+<hash>@bounce.cliente.com
    const hash = this.generateHash(recipientEmail);
    return `bounce+${hash}@bounce.${companyDomain}`;
  }
  
  parseReturnPath(returnPath: string): {
    originalRecipient: string;
    companyDomain: string;
  }
}
```

#### **Warmup Scheduler Service**
```typescript
// apps/worker/src/services/warmup-scheduler.service.ts
class WarmupSchedulerService {
  async getDailyLimit(domain: string): Promise<number> {
    const warmup = await this.getWarmupConfig(domain);
    
    if (!warmup.enabled) {
      return warmup.maxDailyVolume;
    }
    
    const daysSinceStart = this.daysSince(warmup.startDate);
    return this.calculateWarmupLimit(daysSinceStart, warmup.schedule);
  }
  
  private calculateWarmupLimit(day: number, schedule: WarmupSchedule): number {
    // Dia 1: 50 emails
    // Dia 2: 100 emails
    // Dia 3: 200 emails
    // ...crescimento gradual at√© limite
  }
}
```

### 4.2 Novos Workers

```typescript
// apps/worker/src/webhook-ingest-worker.ts
class WebhookIngestWorker {
  async process(job: Job<WebhookData>) {
    const { provider, payload } = job.data;
    
    switch (provider) {
      case 'postal':
        await this.processPostalWebhook(payload);
        break;
      case 'mailu':
        await this.processMailuWebhook(payload);
        break;
      // ...
    }
  }
  
  private async processPostalWebhook(payload: any) {
    // Parse bounce/complaint/delivery
    // Atualizar email_logs
    // Adicionar √† suppression se necess√°rio
    // Trigger client webhooks
  }
}
```

```typescript
// apps/worker/src/dns-verification-worker.ts
class DNSVerificationWorker {
  async process(job: Job<DomainVerificationJob>) {
    const { domainId } = job.data;
    
    // 1. Buscar records esperados
    const expectedRecords = await this.getExpectedDNSRecords(domainId);
    
    // 2. Verificar cada record via DNS lookup
    const results = await Promise.all(
      expectedRecords.map(r => this.verifyRecord(r))
    );
    
    // 3. Atualizar status no banco
    await this.updateDomainOnboardingStatus(domainId, results);
    
    // 4. Se tudo OK, marcar como PRODUCTION_READY
    if (this.allRecordsValid(results)) {
      await this.markProductionReady(domainId);
    }
  }
}
```

```typescript
// apps/worker/src/reputation-calculator-worker.ts
class ReputationCalculatorWorker {
  async process(job: Job) {
    const companies = await this.getAllCompanies();
    
    for (const company of companies) {
      const metrics = await this.calculateMetrics(company.id);
      
      await this.saveReputationMetric({
        companyId: company.id,
        date: new Date(),
        ...metrics,
        reputationScore: this.calculateScore(metrics),
      });
      
      // Verificar guardrails
      if (metrics.bounceRate >= 0.02 || metrics.complaintRate >= 0.001) {
        await this.triggerAlert(company.id, metrics);
        await this.pauseSending(company.id);
      }
    }
  }
}
```

---

## üìù 5. IMPLEMENTA√á√ïES ESPEC√çFICAS

### 5.1 Driver Postal (SMTP)

```typescript
// apps/worker/src/drivers/postal/postal-smtp-driver.ts
export class PostalSMTPDriver implements IEmailDriver {
  private transporter: nodemailer.Transporter;
  
  constructor(config: DriverConfig) {
    this.transporter = nodemailer.createTransport({
      host: config.host,
      port: config.port,
      secure: config.secure,
      auth: {
        user: config.auth.user,
        pass: config.auth.pass,
      },
    });
  }
  
  async sendEmail(job: EmailSendJobData, config: DriverConfig): Promise<SendResult> {
    // 1. Selecionar IP pool
    const ipPool = await this.selectIPPool(job);
    
    // 2. Gerar Return-Path dedicado
    const returnPath = this.generateReturnPath(job);
    
    // 3. Construir headers
    const headers = {
      'List-Unsubscribe': this.buildUnsubscribeHeader(job),
      'List-Id': `<${job.companyId}.emails.certshift.com>`,
      'X-IP-Pool': ipPool?.name,
      ...job.headers,
    };
    
    // 4. Verificar rate limit MX
    await this.checkMXRateLimit(job.to);
    
    // 5. Enviar via SMTP
    const info = await this.transporter.sendMail({
      from: config.fromAddress,
      to: job.to,
      subject: job.subject,
      html: job.htmlContent,
      headers,
      envelope: {
        from: returnPath,
        to: job.to,
      },
    });
    
    return {
      success: true,
      messageId: info.messageId,
      provider: EmailProvider.POSTAL_SMTP,
      ipAddress: ipPool?.ipAddresses[0],
    };
  }
}
```

### 5.2 Webhook Ingest (Postal)

```typescript
// apps/api/src/modules/webhook/postal-webhook.controller.ts
@Controller('webhooks/postal')
export class PostalWebhookController {
  @Post()
  async handleWebhook(@Body() payload: any) {
    // 1. Validar signature (HMAC)
    if (!this.validateSignature(payload)) {
      throw new UnauthorizedException();
    }
    
    // 2. Parse evento
    const event = this.parsePostalEvent(payload);
    
    // 3. Enfileirar para processamento
    await this.queueService.enqueue('webhook-ingest', {
      provider: 'postal',
      event,
      receivedAt: new Date(),
    });
    
    return { status: 'accepted' };
  }
  
  private parsePostalEvent(payload: any): WebhookEvent {
    switch (payload.event) {
      case 'MessageDelivered':
        return {
          type: 'delivery',
          messageId: payload.message.id,
          timestamp: payload.timestamp,
        };
      case 'MessageBounced':
        return {
          type: 'bounce',
          messageId: payload.message.id,
          bounceType: this.classifyBounce(payload.bounce),
          diagnosticCode: payload.bounce.code,
        };
      case 'MessageComplaint':
        return {
          type: 'complaint',
          messageId: payload.message.id,
          feedbackType: payload.complaint.type,
        };
    }
  }
}
```

### 5.3 DKIM Generator

```typescript
// apps/api/src/modules/onboarding/dkim-generator.service.ts
export class DKIMGeneratorService {
  async generateKeyPair(domain: string): Promise<DKIMKeyPair> {
    // Gerar par RSA 2048-bit
    const { publicKey, privateKey } = crypto.generateKeyPairSync('rsa', {
      modulusLength: 2048,
      publicKeyEncoding: {
        type: 'spki',
        format: 'pem',
      },
      privateKeyEncoding: {
        type: 'pkcs8',
        format: 'pem',
      },
    });
    
    // Gerar selector (ex: s20251030)
    const selector = this.generateSelector();
    
    // Formatar public key para DNS TXT record
    const dnsValue = this.formatPublicKeyForDNS(publicKey);
    
    return {
      selector,
      publicKey: dnsValue,
      privateKey: await this.encryptPrivateKey(privateKey),
      dnsRecord: {
        type: 'TXT',
        name: `${selector}._domainkey.${domain}`,
        value: `v=DKIM1; k=rsa; p=${dnsValue}`,
      },
    };
  }
  
  private generateSelector(): string {
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    return `s${date}`; // s20251030
  }
}
```

### 5.4 DNS Auto-Verification

```typescript
// apps/api/src/modules/onboarding/dns-verifier.service.ts
export class DNSVerifierService {
  async verifyAllRecords(domainId: string): Promise<VerificationResult> {
    const domain = await this.getDomain(domainId);
    const onboarding = await this.getOnboarding(domainId);
    
    const checks = await Promise.all([
      this.verifyDKIM(domain, onboarding),
      this.verifySPF(domain),
      this.verifyReturnPath(domain, onboarding),
    ]);
    
    const allPassed = checks.every(c => c.valid);
    
    if (allPassed) {
      await this.markProductionReady(domainId);
    }
    
    return {
      domain: domain.domain,
      checks,
      allPassed,
      productionReady: allPassed,
    };
  }
  
  private async verifyDKIM(domain: Domain, onboarding: DomainOnboarding): Promise<CheckResult> {
    const record = `${onboarding.dkimSelector}._domainkey.${domain.domain}`;
    
    try {
      const result = await dns.resolveTxt(record);
      const txtValue = result[0].join('');
      
      // Verificar se cont√©m a chave p√∫blica
      const hasPublicKey = txtValue.includes(onboarding.dkimPublic);
      
      return {
        type: 'DKIM',
        record,
        expected: `v=DKIM1; k=rsa; p=${onboarding.dkimPublic}`,
        found: txtValue,
        valid: hasPublicKey,
      };
    } catch (error) {
      return {
        type: 'DKIM',
        record,
        valid: false,
        error: 'DNS record not found',
      };
    }
  }
}
```

### 5.5 MX Rate Limiter (Redis)

```typescript
// apps/worker/src/services/mx-rate-limiter.service.ts
export class MXRateLimiterService {
  private readonly limits = {
    'gmail.com': { perSecond: 20, perMinute: 1000 },
    'googlemail.com': { perSecond: 20, perMinute: 1000 },
    'outlook.com': { perSecond: 10, perMinute: 500 },
    'hotmail.com': { perSecond: 10, perMinute: 500 },
    'yahoo.com': { perSecond: 5, perMinute: 250 },
    'default': { perSecond: 1, perMinute: 50 },
  };
  
  async checkLimit(email: string): Promise<{ allowed: boolean; retryAfter?: number }> {
    const mxDomain = this.extractMXDomain(email);
    const limit = this.limits[mxDomain] || this.limits.default;
    
    // Sliding window no Redis
    const key = `mx:${mxDomain}:${Math.floor(Date.now() / 1000)}`;
    const count = await this.redis.incr(key);
    await this.redis.expire(key, 60);
    
    if (count > limit.perSecond) {
      const retryAfter = 1000; // 1 segundo
      return { allowed: false, retryAfter };
    }
    
    return { allowed: true };
  }
  
  private extractMXDomain(email: string): string {
    const domain = email.split('@')[1].toLowerCase();
    
    // Normalizar dom√≠nios conhecidos
    if (domain.includes('gmail')) return 'gmail.com';
    if (domain.includes('googlemail')) return 'gmail.com';
    if (domain.includes('outlook')) return 'outlook.com';
    if (domain.includes('hotmail')) return 'outlook.com';
    if (domain.includes('yahoo')) return 'yahoo.com';
    
    return domain;
  }
}
```

### 5.6 Suppression Service

```typescript
// apps/api/src/modules/suppression/suppression.service.ts
export class SuppressionService {
  async addToSuppression(data: {
    companyId?: string;
    email: string;
    reason: SuppressionReason;
    source?: string;
    expiresAt?: Date;
  }): Promise<void> {
    const domain = data.email.split('@')[1];
    
    await prisma.suppression.upsert({
      where: {
        companyId_email: {
          companyId: data.companyId || null,
          email: data.email,
        },
      },
      create: {
        ...data,
        domain,
      },
      update: {
        reason: data.reason,
        source: data.source,
        suppressedAt: new Date(),
      },
    });
  }
  
  async checkSuppression(companyId: string, email: string): Promise<{
    suppressed: boolean;
    reason?: string;
  }> {
    // Verificar supress√£o por empresa
    const companySuppression = await prisma.suppression.findUnique({
      where: {
        companyId_email: { companyId, email },
      },
    });
    
    if (companySuppression) {
      return {
        suppressed: true,
        reason: companySuppression.reason,
      };
    }
    
    // Verificar supress√£o global
    const globalSuppression = await prisma.suppression.findFirst({
      where: {
        companyId: null,
        email,
      },
    });
    
    if (globalSuppression) {
      return {
        suppressed: true,
        reason: globalSuppression.reason,
      };
    }
    
    // Verificar role accounts (admin@, info@, postmaster@, etc)
    if (this.isRoleAccount(email)) {
      return {
        suppressed: true,
        reason: 'role_account',
      };
    }
    
    return { suppressed: false };
  }
  
  private isRoleAccount(email: string): boolean {
    const roleAccounts = [
      'admin', 'info', 'postmaster', 'abuse', 'noreply',
      'support', 'help', 'contact', 'sales', 'webmaster',
    ];
    
    const localPart = email.split('@')[0].toLowerCase();
    return roleAccounts.includes(localPart);
  }
}
```

### 5.7 Reputation Monitor

```typescript
// apps/worker/src/services/reputation-monitor.service.ts
export class ReputationMonitorService {
  async checkAndEnforce(companyId: string): Promise<void> {
    const metrics = await this.calculateLast24hMetrics(companyId);
    
    // Guardrail: Bounce Rate ‚â• 2%
    if (metrics.bounceRate >= 0.02) {
      await this.pauseSending(companyId, 'High bounce rate detected');
      await this.sendAlert(companyId, {
        type: 'high_bounce_rate',
        value: metrics.bounceRate,
        threshold: 0.02,
      });
    }
    
    // Guardrail: Complaint Rate ‚â• 0.1%
    if (metrics.complaintRate >= 0.001) {
      await this.pauseSending(companyId, 'High complaint rate detected');
      await this.sendAlert(companyId, {
        type: 'high_complaint_rate',
        value: metrics.complaintRate,
        threshold: 0.001,
      });
    }
    
    // Warmup: verificar se est√° dentro do limite di√°rio
    const warmupLimit = await this.warmupScheduler.getDailyLimit(companyId);
    if (metrics.sentToday >= warmupLimit) {
      await this.throttleSending(companyId, 'Daily warmup limit reached');
    }
  }
  
  private async calculateLast24hMetrics(companyId: string): Promise<Metrics> {
    const since = new Date(Date.now() - 24 * 60 * 60 * 1000);
    
    const [sent, bounced, complained] = await Promise.all([
      prisma.emailLog.count({
        where: {
          companyId,
          status: 'SENT',
          sentAt: { gte: since },
        },
      }),
      prisma.emailLog.count({
        where: {
          companyId,
          bounceType: { not: null },
          createdAt: { gte: since },
        },
      }),
      prisma.emailLog.count({
        where: {
          companyId,
          complaintFeedbackType: { not: null },
          createdAt: { gte: since },
        },
      }),
    ]);
    
    return {
      sent,
      bounced,
      complained,
      bounceRate: sent > 0 ? bounced / sent : 0,
      complaintRate: sent > 0 ? complained / sent : 0,
      sentToday: sent,
    };
  }
}
```

---

## üîÑ 6. PLANO DE MIGRA√á√ÉO - 3 TRACKS PARALELAS

> **Estrat√©gia:** Dividir o trabalho em 3 tracks independentes para 3 desenvolvedores trabalharem simultaneamente, minimizando conflitos de merge.

---

## üéØ RESUMO DAS 3 TRACKS

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     DIVIS√ÉO DE RESPONSABILIDADES                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üë§ PERSON A (Track 1)         üë§ PERSON B (Track 2)         üë§ PERSON C (Track 3)
Backend S√™nior                Backend Pleno/S√™nior          Full-Stack
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìÇ apps/worker/src/drivers/   üìÇ apps/worker/src/services/  üìÇ apps/api/src/modules/
üìÇ apps/api/src/modules/      üìÇ apps/api/src/modules/      üìÇ apps/dashboard/src/
   ‚îú‚îÄ ip-pool/                   ‚îú‚îÄ webhook/                   ‚îî‚îÄ onboarding/
   ‚îú‚îÄ provider/                  ‚îú‚îÄ suppression/                  ‚îî‚îÄ pages/
   ‚îî‚îÄ rate-limit/                ‚îú‚îÄ tracking/
                                 ‚îî‚îÄ reputation/

üéØ FOCO:                      üéØ FOCO:                      üéØ FOCO:
‚Ä¢ Drivers de envio            ‚Ä¢ Webhooks & Parsers          ‚Ä¢ DNS & DKIM
‚Ä¢ IP Pools                    ‚Ä¢ DSN/ARF                     ‚Ä¢ Onboarding autom√°tico
‚Ä¢ Rate limiting MX            ‚Ä¢ Supress√£o                   ‚Ä¢ Dashboard
‚Ä¢ Providers & Fallback        ‚Ä¢ Reputa√ß√£o & Guardrails      ‚Ä¢ Frontend
                             ‚Ä¢ Tracking opens/clicks       ‚Ä¢ Postmaster

‚è±Ô∏è DURA√á√ÉO: 12 semanas        ‚è±Ô∏è DURA√á√ÉO: 12 semanas        ‚è±Ô∏è DURA√á√ÉO: 12 semanas

üîÄ MERGES: Sprint 1,2,3,4,5   üîÄ MERGES: Sprint 2,3,4,5,6   üîÄ MERGES: Sprint 2,3,4,5,6
```

### ‚ö° Vantagens da Abordagem Paralela

1. **Redu√ß√£o de 57% no tempo** (28 semanas ‚Üí 12 semanas)
2. **M√≠nimos conflitos de merge** (diret√≥rios isolados)
3. **Sprints curtos** (2 semanas) com entregas incrementais
4. **Checkpoints frequentes** para valida√ß√£o
5. **Rollback f√°cil** se algo der errado

### üîÄ Pontos de Sincroniza√ß√£o

| Sprint | Semana | Merge | Componentes |
|--------|--------|-------|-------------|
| Sprint 1 | 2 | Track 1 ‚Üí main | Interface + SES refatorado |
| Sprint 2 | 4 | **TODOS** ‚Üí main | Postal + Webhooks + DKIM |
| Sprint 3 | 6 | **TODOS** ‚Üí main | IP Pools + Supress√£o + DNS |
| Sprint 4 | 8 | **BIG MERGE** üî• | Integra√ß√£o completa - MVP READY |
| Sprint 5 | 10 | **TODOS** ‚Üí main | Features avan√ßadas |
| Sprint 6 | 11 | Final ‚Üí main | Deploy prep |
| Sprint 7 | 12 | üöÄ | **PRODU√á√ÉO** |

---

## üöÄ GUIA DE IN√çCIO R√ÅPIDO POR DESENVOLVEDOR

### üìã Person A - Track 1 (Drivers & Infraestrutura)

**Primeira Semana:**
1. Criar branch `track-1-drivers` a partir de `feature/esp-selfhosted`
2. Criar estrutura de diret√≥rios:
   ```bash
   mkdir -p apps/worker/src/drivers/{base,aws-ses,postal}
   mkdir -p apps/api/src/modules/{ip-pool,provider,rate-limit}
   ```
3. Criar interface `IEmailDriver` em `drivers/base/email-driver.interface.ts`
4. Refatorar `SESService` para nova estrutura
5. **Checkpoint:** SES funcionando sem quebrar nada

**Arquivos Principais:**
- `apps/worker/src/drivers/base/email-driver.interface.ts`
- `apps/worker/src/drivers/driver-factory.ts`
- `apps/worker/src/services/email-driver.service.ts`

**Testes Cr√≠ticos:**
- [ ] Envio via SES continua funcionando 100%
- [ ] Interface aceita m√∫ltiplos drivers
- [ ] Factory consegue instanciar drivers

---

### üìã Person B - Track 2 (Webhooks & Processamento)

**Primeira Semana:**
1. Criar branch `track-2-webhooks` a partir de `feature/esp-selfhosted`
2. Criar estrutura de diret√≥rios:
   ```bash
   mkdir -p apps/worker/src/services
   mkdir -p apps/worker/src/types
   mkdir -p apps/api/src/modules/{webhook,suppression,tracking,reputation}
   ```
3. Estudar RFCs: RFC 3464 (DSN) e RFC 5965 (ARF)
4. Implementar parsers de DSN e ARF
5. **Checkpoint:** Parsers testados com payloads reais

**Arquivos Principais:**
- `apps/worker/src/services/dsn-parser.service.ts`
- `apps/worker/src/services/arf-parser.service.ts`
- `apps/worker/src/services/bounce-classifier.service.ts`

**Testes Cr√≠ticos:**
- [ ] Parser DSN identifica bounce type corretamente
- [ ] Parser ARF extrai complaint info
- [ ] Classificador diferencia hard/soft bounce

---

### üìã Person C - Track 3 (Dom√≠nios & Frontend)

**Primeira Semana:**
1. Criar branch `track-3-domains` a partir de `feature/esp-selfhosted`
2. Criar estrutura de diret√≥rios:
   ```bash
   mkdir -p apps/api/src/modules/onboarding
   mkdir -p apps/dashboard/src/pages/{domains,reputation,metrics}
   mkdir -p packages/shared/src/crypto
   ```
3. Estudar DKIM (RFC 6376) e gera√ß√£o de chaves RSA
4. Implementar gerador de DKIM
5. **Checkpoint:** Par de chaves DKIM gerado com sucesso

**Arquivos Principais:**
- `apps/api/src/modules/onboarding/dkim-generator.service.ts`
- `apps/api/src/modules/onboarding/onboarding.controller.ts`
- `packages/shared/src/crypto/dkim-crypto.ts`

**Testes Cr√≠ticos:**
- [ ] Gera par RSA 2048-bit v√°lido
- [ ] Formata chave p√∫blica para DNS TXT
- [ ] Encripta chave privada para storage

---

## üèÅ Fase 0: Prepara√ß√£o (TODOS - 1 semana)

### Setup Inicial (Tech Lead)
- [ ] Criar branch `feature/esp-selfhosted`
- [ ] Criar sub-branches: `track-1-drivers`, `track-2-webhooks`, `track-3-domains`
- [ ] Configurar ambiente de desenvolvimento com Postal/Mailu
- [ ] Definir feature flags e estrat√©gia de merge
- [ ] Documentar arquitetura e divis√£o de responsabilidades

### Migrations (Tech Lead + Person A)
- [ ] Criar todas as migrations do banco de dados
- [ ] Aplicar migrations em dev
- [ ] Validar schemas

**üéØ Checkpoint:** Branches criadas, ambiente configurado, banco atualizado

---

## üë§ TRACK 1: INFRAESTRUTURA & DRIVERS
**Respons√°vel:** Person A (Dev Backend S√™nior)  
**Branch:** `track-1-drivers`  
**Foco:** Sistema de drivers, providers, IP pools, rate limiting

### Semana 1-2: Abstra√ß√£o Base
```
üìÇ Arquivos a criar/modificar:
apps/worker/src/
‚îú‚îÄ‚îÄ drivers/
‚îÇ   ‚îú‚îÄ‚îÄ base/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email-driver.interface.ts       ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email-driver-result.ts          ‚ú® NOVO
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ driver-config.types.ts          ‚ú® NOVO
‚îÇ   ‚îî‚îÄ‚îÄ driver-factory.ts                    ‚ú® NOVO
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ email-driver.service.ts              ‚ú® NOVO

apps/worker/src/services/
‚îú‚îÄ‚îÄ ses.service.ts                           ‚ôªÔ∏è REFATORAR ‚Üí drivers/aws-ses/ses-driver.ts
```

**Tasks:**
- [ ] Criar interface `IEmailDriver` base
- [ ] Criar tipos `SendResult`, `DriverConfig`
- [ ] Implementar `DriverFactory`
- [ ] Refatorar `SESService` ‚Üí `SESDriver` (mant√©m funcionalidade 100%)
- [ ] Criar `EmailDriverService` (orquestrador)
- [ ] Mover SES para `drivers/aws-ses/ses-driver.ts`
- [ ] Adicionar toggle `EMAIL_PROVIDER` no env
- [ ] Testes unit√°rios
- [ ] **Checkpoint:** SES funcionando via nova arquitetura

### Semana 3-4: Driver Postal SMTP
```
üìÇ Arquivos a criar:
apps/worker/src/drivers/postal/
‚îú‚îÄ‚îÄ postal-smtp-driver.ts                    ‚ú® NOVO
‚îú‚îÄ‚îÄ postal-config.ts                         ‚ú® NOVO
‚îî‚îÄ‚îÄ return-path-generator.ts                 ‚ú® NOVO

docker-compose.yml                           ‚ôªÔ∏è ADICIONAR postal service
```

**Tasks:**
- [ ] Implementar `PostalSMTPDriver` (interface `IEmailDriver`)
- [ ] Configurar Postal no docker-compose
- [ ] Implementar Return-Path dedicado (`bounce+hash@bounce.cliente.com`)
- [ ] Implementar List-Unsubscribe headers (mailto + https)
- [ ] Testes de envio real
- [ ] **Checkpoint:** Envios via Postal SMTP funcionando

### Semana 5-6: IP Pools & Rate Limiting
```
üìÇ Arquivos a criar:
apps/api/src/modules/ip-pool/
‚îú‚îÄ‚îÄ ip-pool.controller.ts                    ‚ú® NOVO
‚îú‚îÄ‚îÄ ip-pool.service.ts                       ‚ú® NOVO
‚îî‚îÄ‚îÄ dto/
    ‚îú‚îÄ‚îÄ create-ip-pool.dto.ts                ‚ú® NOVO
    ‚îî‚îÄ‚îÄ ip-pool-response.dto.ts              ‚ú® NOVO

apps/worker/src/services/
‚îú‚îÄ‚îÄ ip-pool-selector.service.ts              ‚ú® NOVO
‚îî‚îÄ‚îÄ mx-rate-limiter.service.ts               ‚ú® NOVO

apps/api/src/modules/rate-limit/
‚îú‚îÄ‚îÄ rate-limit.controller.ts                 ‚ú® NOVO
‚îî‚îÄ‚îÄ rate-limit.service.ts                    ‚ú® NOVO
```

**Tasks:**
- [ ] Criar CRUD de IP Pools (API)
- [ ] Implementar `IPPoolSelectorService` (seleciona IP por tipo)
- [ ] Implementar `MXRateLimiterService` (Redis sliding window)
- [ ] Configurar limites: Gmail (20/s), Outlook (10/s), Yahoo (5/s)
- [ ] Integrar com drivers de envio
- [ ] Dashboard b√°sico de m√©tricas
- [ ] **Checkpoint:** Rate limiting por MX funcional

### Semana 7-8: Providers & Fallback
```
üìÇ Arquivos a criar:
apps/api/src/modules/provider/
‚îú‚îÄ‚îÄ provider.controller.ts                   ‚ú® NOVO
‚îú‚îÄ‚îÄ provider.service.ts                      ‚ú® NOVO
‚îî‚îÄ‚îÄ dto/

packages/shared/src/types/
‚îî‚îÄ‚îÄ email-provider.types.ts                  ‚ú® NOVO
```

**Tasks:**
- [ ] Criar CRUD de Email Providers (tabela `email_providers`)
- [ ] Implementar sistema de prioridade
- [ ] Implementar fallback autom√°tico (SES ‚Üí Postal)
- [ ] Testes de failover
- [ ] **Checkpoint:** Multi-provider com fallback

### Semana 9: Drivers Adicionais (Opcional)
```
üìÇ Arquivos a criar:
apps/worker/src/drivers/
‚îú‚îÄ‚îÄ postal/postal-api-driver.ts              ‚ú® NOVO
‚îú‚îÄ‚îÄ mailu/mailu-smtp-driver.ts               ‚ú® NOVO
‚îî‚îÄ‚îÄ haraka/haraka-api-driver.ts              ‚ú® NOVO
```

**Tasks:**
- [ ] Implementar `PostalAPIDriver`
- [ ] Implementar `MailuSMTPDriver`
- [ ] Implementar `HarakaAPIDriver`
- [ ] Testes de integra√ß√£o
- [ ] **Checkpoint:** M√∫ltiplos drivers funcionando

---

## üë§ TRACK 2: WEBHOOKS & PROCESSAMENTO
**Respons√°vel:** Person B (Dev Backend Pleno/S√™nior)  
**Branch:** `track-2-webhooks`  
**Foco:** Webhooks, parsers, supress√£o, reputa√ß√£o, tracking

### Semana 1-2: Parsers DSN/ARF
```
üìÇ Arquivos a criar:
apps/worker/src/services/
‚îú‚îÄ‚îÄ dsn-parser.service.ts                    ‚ú® NOVO
‚îú‚îÄ‚îÄ arf-parser.service.ts                    ‚ú® NOVO
‚îî‚îÄ‚îÄ bounce-classifier.service.ts             ‚ú® NOVO

apps/worker/src/types/
‚îú‚îÄ‚îÄ dsn-report.types.ts                      ‚ú® NOVO
‚îî‚îÄ‚îÄ arf-report.types.ts                      ‚ú® NOVO
```

**Tasks:**
- [ ] Implementar `DSNParserService` (RFC 3464)
- [ ] Implementar `ARFParserService` (RFC 5965)
- [ ] Implementar classificador de bounces (hard/soft/transient)
- [ ] Testes com payloads reais
- [ ] **Checkpoint:** Parsers funcionando

### Semana 3-4: Webhooks Postal
```
üìÇ Arquivos a criar:
apps/api/src/modules/webhook/
‚îú‚îÄ‚îÄ postal-webhook.controller.ts             ‚ú® NOVO
‚îú‚îÄ‚îÄ postal-webhook-validator.service.ts      ‚ú® NOVO
‚îî‚îÄ‚îÄ webhook-signature.service.ts             ‚ú® NOVO

apps/worker/src/
‚îú‚îÄ‚îÄ webhook-ingest-worker.ts                 ‚ú® NOVO
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ webhook-event-processor.service.ts   ‚ú® NOVO
```

**Tasks:**
- [ ] Criar `PostalWebhookController` (recebe webhooks)
- [ ] Implementar valida√ß√£o de signature (HMAC)
- [ ] Criar worker de processamento (`webhook-ingest-worker`)
- [ ] Processar eventos: bounce, complaint, delivery, open, click
- [ ] Integrar com parsers DSN/ARF
- [ ] Atualizar `email_logs` com eventos
- [ ] **Checkpoint:** Webhooks Postal processados

### Semana 5-6: Sistema de Supress√£o
```
üìÇ Arquivos a criar:
apps/api/src/modules/suppression/
‚îú‚îÄ‚îÄ suppression.controller.ts                ‚ú® NOVO
‚îú‚îÄ‚îÄ suppression.service.ts                   ‚ú® NOVO
‚îú‚îÄ‚îÄ suppression-import.service.ts            ‚ú® NOVO
‚îî‚îÄ‚îÄ dto/
    ‚îú‚îÄ‚îÄ add-suppression.dto.ts               ‚ú® NOVO
    ‚îú‚îÄ‚îÄ check-suppression.dto.ts             ‚ú® NOVO
    ‚îî‚îÄ‚îÄ import-suppression.dto.ts            ‚ú® NOVO

apps/worker/src/services/
‚îî‚îÄ‚îÄ auto-suppression.service.ts              ‚ú® NOVO
```

**Tasks:**
- [ ] Migrar dados `recipient_blocklist` ‚Üí `suppressions`
- [ ] Criar CRUD de Suppressions (API)
- [ ] Implementar supress√£o global (companyId = null)
- [ ] Implementar detec√ß√£o de role accounts (admin@, info@, etc)
- [ ] Implementar importa√ß√£o em massa (CSV)
- [ ] Endpoint `POST /suppressions/check`
- [ ] Integrar com `email-send.service.ts` (bloquear antes de enviar)
- [ ] Auto-adicionar em hard bounce + complaint
- [ ] **Checkpoint:** Sistema de supress√£o completo

### Semana 7-8: Reputa√ß√£o & Guardrails
```
üìÇ Arquivos a criar:
apps/worker/src/services/
‚îú‚îÄ‚îÄ reputation-monitor.service.ts            ‚ú® NOVO (ou ‚ôªÔ∏è expandir existente)
‚îú‚îÄ‚îÄ reputation-calculator.service.ts         ‚ú® NOVO
‚îî‚îÄ‚îÄ guardrails.service.ts                    ‚ú® NOVO

apps/worker/src/
‚îî‚îÄ‚îÄ reputation-calculator-worker.ts          ‚ú® NOVO

apps/api/src/modules/reputation/
‚îú‚îÄ‚îÄ reputation.controller.ts                 ‚ú® NOVO
‚îî‚îÄ‚îÄ reputation.service.ts                    ‚ú® NOVO
```

**Tasks:**
- [ ] Implementar `ReputationCalculatorService`
- [ ] Criar worker de c√°lculo di√°rio de m√©tricas
- [ ] Implementar `GuardrailsService`
  - Pausar se bounce ‚â• 2%
  - Pausar se complaint ‚â• 0.1%
- [ ] Criar alertas autom√°ticos (email, webhook, Slack)
- [ ] Dashboard de reputa√ß√£o (endpoint API)
- [ ] Salvar em `reputation_metrics` (daily)
- [ ] **Checkpoint:** Monitoramento e guardrails ativos

### Semana 9-10: Tracking (Opens/Clicks)
```
üìÇ Arquivos a criar:
apps/api/src/modules/tracking/
‚îú‚îÄ‚îÄ tracking.controller.ts                   ‚ú® NOVO
‚îú‚îÄ‚îÄ tracking.service.ts                      ‚ú® NOVO
‚îú‚îÄ‚îÄ pixel-generator.service.ts               ‚ú® NOVO
‚îî‚îÄ‚îÄ link-rewriter.service.ts                 ‚ú® NOVO

apps/worker/src/services/
‚îî‚îÄ‚îÄ html-tracking-injector.service.ts        ‚ú® NOVO
```

**Tasks:**
- [ ] Implementar pixel de abertura (1x1 transparente)
- [ ] Implementar rewrite de links (tracking de cliques)
- [ ] Endpoint `GET /track/open/:trackingId`
- [ ] Endpoint `GET /track/click/:trackingId/:linkId`
- [ ] Injetar tracking no HTML (worker)
- [ ] Salvar eventos em `email_tracking`
- [ ] Dashboard de engajamento (API)
- [ ] **Checkpoint:** Tracking completo

### Semana 11: Warm-up Scheduler
```
üìÇ Arquivos a criar:
apps/worker/src/services/
‚îî‚îÄ‚îÄ warmup-scheduler.service.ts              ‚ú® NOVO

apps/api/src/modules/domain/
‚îî‚îÄ‚îÄ warmup-config.service.ts                 ‚ú® NOVO (ou integrar em domain.service.ts)
```

**Tasks:**
- [ ] Implementar `WarmupSchedulerService`
- [ ] Calcular limite di√°rio baseado em warmup schedule
- [ ] Escalonar: Dia 1 (50), Dia 2 (100), Dia 3 (200)...
- [ ] Frear envios se limite di√°rio atingido
- [ ] Rollback se m√©tricas ruins
- [ ] **Checkpoint:** Warm-up autom√°tico

---

## üë§ TRACK 3: DOM√çNIOS & ONBOARDING
**Respons√°vel:** Person C (Dev Full-Stack)  
**Branch:** `track-3-domains`  
**Foco:** DNS, DKIM, onboarding autom√°tico, dashboard

### Semana 1-2: DKIM Generator
```
üìÇ Arquivos a criar:
apps/api/src/modules/onboarding/
‚îú‚îÄ‚îÄ onboarding.module.ts                     ‚ú® NOVO
‚îú‚îÄ‚îÄ onboarding.controller.ts                 ‚ú® NOVO
‚îú‚îÄ‚îÄ onboarding.service.ts                    ‚ú® NOVO
‚îú‚îÄ‚îÄ dkim-generator.service.ts                ‚ú® NOVO
‚îî‚îÄ‚îÄ dto/
    ‚îú‚îÄ‚îÄ start-onboarding.dto.ts              ‚ú® NOVO
    ‚îî‚îÄ‚îÄ onboarding-response.dto.ts           ‚ú® NOVO

packages/shared/src/crypto/
‚îî‚îÄ‚îÄ dkim-crypto.ts                           ‚ú® NOVO
```

**Tasks:**
- [ ] Implementar `DKIMGeneratorService`
- [ ] Gerar par RSA 2048-bit
- [ ] Gerar selector (ex: `s20251030`)
- [ ] Formatar chave p√∫blica para DNS TXT
- [ ] Encriptar chave privada (storage seguro)
- [ ] Endpoint `POST /domains/:id/onboarding/generate-dkim`
- [ ] Salvar em `domain_onboarding`
- [ ] **Checkpoint:** DKIM gerado automaticamente

### Semana 3-4: DNS Verification
```
üìÇ Arquivos a criar:
apps/api/src/modules/onboarding/
‚îú‚îÄ‚îÄ dns-verifier.service.ts                  ‚ú® NOVO
‚îî‚îÄ‚îÄ dns-checker.service.ts                   ‚ú® NOVO

apps/worker/src/
‚îú‚îÄ‚îÄ dns-verification-worker.ts               ‚ú® NOVO
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ dns-lookup.service.ts                ‚ú® NOVO
```

**Tasks:**
- [ ] Implementar `DNSVerifierService`
- [ ] Implementar `DNSLookupService` (wrapper do `dns` do Node.js)
- [ ] Verificar DKIM: `<selector>._domainkey.<domain>` (TXT)
- [ ] Verificar SPF: `<domain>` (TXT, come√ßa com `v=spf1`)
- [ ] Verificar Return-Path: `bounce.<domain>` (CNAME ou A)
- [ ] Criar worker de verifica√ß√£o autom√°tica (a cada 1h)
- [ ] Endpoint `POST /domains/:id/onboarding/verify`
- [ ] Atualizar status em `domain_onboarding`
- [ ] **Checkpoint:** DNS verificado automaticamente

### Semana 5-6: Onboarding Checklist
```
üìÇ Arquivos a criar:
apps/api/src/modules/onboarding/
‚îú‚îÄ‚îÄ checklist-generator.service.ts           ‚ú® NOVO
‚îî‚îÄ‚îÄ production-readiness.service.ts          ‚ú® NOVO

apps/dashboard/src/pages/
‚îî‚îÄ‚îÄ domains/
    ‚îú‚îÄ‚îÄ DomainOnboarding.tsx                 ‚ú® NOVO (Frontend)
    ‚îî‚îÄ‚îÄ OnboardingChecklist.tsx              ‚ú® NOVO (Frontend)
```

**Tasks:**
- [ ] Implementar `ChecklistGeneratorService`
- [ ] Gerar checklist completo:
  - ‚úÖ DKIM gerado
  - ‚úÖ DKIM publicado no DNS
  - ‚úÖ SPF configurado
  - ‚úÖ Return-Path configurado
  - ‚úÖ Dom√≠nio verificado
- [ ] Endpoint `GET /domains/:id/onboarding/checklist`
- [ ] Endpoint `POST /domains/:id/onboarding/start`
- [ ] Auto-marcar `PRODUCTION_READY` quando tudo OK
- [ ] Criar UI do checklist (React)
- [ ] **Checkpoint:** Onboarding visual funcionando

### Semana 7-8: Dashboard de Reputa√ß√£o
```
üìÇ Arquivos a criar:
apps/api/src/modules/reputation/
‚îî‚îÄ‚îÄ reputation-dashboard.service.ts          ‚ú® NOVO (ou integrar em reputation.service)

apps/dashboard/src/pages/
‚îú‚îÄ‚îÄ reputation/
‚îÇ   ‚îú‚îÄ‚îÄ ReputationDashboard.tsx              ‚ú® NOVO (Frontend)
‚îÇ   ‚îú‚îÄ‚îÄ DomainReputation.tsx                 ‚ú® NOVO (Frontend)
‚îÇ   ‚îî‚îÄ‚îÄ MetricsChart.tsx                     ‚ú® NOVO (Frontend)
‚îî‚îÄ‚îÄ metrics/
    ‚îî‚îÄ‚îÄ EmailMetricsDashboard.tsx            ‚ú® NOVO (Frontend)
```

**Tasks:**
- [ ] Endpoint `GET /reputation` (empresa)
- [ ] Endpoint `GET /reputation/domain/:id` (por dom√≠nio)
- [ ] Endpoint `GET /metrics/dashboard` (consolidado)
- [ ] Criar dashboard React com gr√°ficos:
  - Taxa de bounce (√∫ltimos 7 dias)
  - Taxa de complaint (√∫ltimos 7 dias)
  - Taxa de abertura
  - Taxa de cliques
  - Reputa√ß√£o score
- [ ] Alertas visuais se guardrails ativados
- [ ] **Checkpoint:** Dashboard completo

### Semana 9-10: DNS Records Management
```
üìÇ Arquivos a criar:
apps/api/src/modules/domain/
‚îú‚îÄ‚îÄ dns-records.controller.ts                ‚ú® NOVO
‚îî‚îÄ‚îÄ dns-records.service.ts                   ‚ú® NOVO

apps/dashboard/src/pages/domains/
‚îî‚îÄ‚îÄ DNSRecordsManager.tsx                    ‚ú® NOVO (Frontend)
```

**Tasks:**
- [ ] CRUD de DNS Records (tabela `dns_records`)
- [ ] Endpoint `GET /domains/:id/dns-records`
- [ ] Endpoint `POST /domains/:id/dns-records` (adicionar manual)
- [ ] Auto-gerar records esperados no onboarding
- [ ] UI para copiar records (copy to clipboard)
- [ ] Status visual (‚úÖ verificado, ‚è≥ pendente, ‚ùå falhou)
- [ ] **Checkpoint:** Gest√£o de DNS completa

### Semana 11: Postmaster Ingest (Opcional)
```
üìÇ Arquivos a criar:
apps/worker/src/services/
‚îú‚îÄ‚îÄ gmail-postmaster.service.ts              ‚ú® NOVO
‚îú‚îÄ‚îÄ ms-snds.service.ts                       ‚ú® NOVO
‚îî‚îÄ‚îÄ dmarc-parser.service.ts                  ‚ú® NOVO

apps/api/src/modules/reputation/
‚îî‚îÄ‚îÄ postmaster.controller.ts                 ‚ú® NOVO
```

**Tasks:**
- [ ] Integra√ß√£o Gmail Postmaster API
- [ ] Integra√ß√£o MS SNDS API
- [ ] Parser de DMARC reports (rua=)
- [ ] Endpoint `GET /reputation/postmaster`
- [ ] Dashboard com m√©tricas externas
- [ ] **Checkpoint:** Ingest de postmaster

---

## üîÄ PONTOS DE SINCRONIZA√á√ÉO (Merge Points)

### Sprint 1 (Semana 2)
**Merge:** Track 1 ‚Üí `main`
- ‚úÖ Interface base de drivers
- ‚úÖ SES refatorado para nova arquitetura
- ‚úÖ Migrations aplicadas

**Depend√™ncias:**
- Track 2 aguarda: Interface `IEmailDriver`
- Track 3: Independente

---

### Sprint 2 (Semana 4)
**Merge:** Track 1 ‚Üí `main`
- ‚úÖ Postal SMTP driver funcionando
- ‚úÖ Docker-compose atualizado

**Merge:** Track 2 ‚Üí `main`
- ‚úÖ Parsers DSN/ARF
- ‚úÖ Webhooks Postal

**Merge:** Track 3 ‚Üí `main`
- ‚úÖ DKIM Generator

**Depend√™ncias:**
- Track 2 pode testar webhooks com Postal do Track 1
- Track 3 independente

---

### Sprint 3 (Semana 6)
**Merge:** Track 1 ‚Üí `main`
- ‚úÖ IP Pools
- ‚úÖ Rate Limiting

**Merge:** Track 2 ‚Üí `main`
- ‚úÖ Sistema de Supress√£o

**Merge:** Track 3 ‚Üí `main`
- ‚úÖ DNS Verification

**Depend√™ncias:**
- Track 1 IP Pools podem ser usados por Track 2 Reputa√ß√£o

---

### Sprint 4 (Semana 8)
**Merge:** TODOS ‚Üí `main` (Big Merge)
- ‚úÖ Providers & Fallback (Track 1)
- ‚úÖ Reputa√ß√£o & Guardrails (Track 2)
- ‚úÖ Onboarding Checklist (Track 3)

**Testes de Integra√ß√£o:**
- [ ] Envio end-to-end com todos componentes
- [ ] Webhooks processando e afetando reputa√ß√£o
- [ ] Onboarding completo com verifica√ß√£o DNS

---

### Sprint 5 (Semana 10)
**Merge:** TODOS ‚Üí `main`
- ‚úÖ Drivers adicionais (Track 1)
- ‚úÖ Tracking opens/clicks (Track 2)
- ‚úÖ Dashboard completo (Track 3)

---

### Sprint 6 (Semana 11)
**Merge:** Final ‚Üí `main`
- ‚úÖ Warm-up scheduler (Track 2)
- ‚úÖ Postmaster ingest (Track 3 - opcional)

**Testes Finais:**
- [ ] Testes end-to-end completos
- [ ] Testes de carga
- [ ] Testes de failover
- [ ] Documenta√ß√£o completa

---

### Sprint 7 (Semana 12)
**Deploy:**
- [ ] Deploy em staging
- [ ] Testes com clientes beta
- [ ] Deploy em produ√ß√£o (gradual)

---

## üìã QUADRO DE DEPEND√äNCIAS

| Track | Depende de | Pode ser usado por |
|-------|------------|-------------------|
| Track 1 (Drivers) | Migrations | Track 2 (webhooks precisam saber provider)<br>Track 3 (onboarding precisa saber qual MTA) |
| Track 2 (Webhooks) | Track 1 (interface driver)<br>Migrations | Track 3 (reputa√ß√£o afeta onboarding) |
| Track 3 (Domains) | Migrations | Track 1 (drivers usam dom√≠nios verificados)<br>Track 2 (reputa√ß√£o por dom√≠nio) |

---

## üîß ESTRAT√âGIA DE MERGE

### Regra de Ouro
**Cada track trabalha em diret√≥rios distintos:**

```
Track 1 (Person A):
  apps/worker/src/drivers/
  apps/api/src/modules/ip-pool/
  apps/api/src/modules/provider/
  apps/api/src/modules/rate-limit/

Track 2 (Person B):
  apps/worker/src/services/ (parsers, reputation, suppression)
  apps/worker/src/*-worker.ts (novos workers)
  apps/api/src/modules/webhook/
  apps/api/src/modules/suppression/
  apps/api/src/modules/tracking/

Track 3 (Person C):
  apps/api/src/modules/onboarding/
  apps/api/src/modules/domain/ (expans√£o)
  apps/dashboard/src/pages/ (frontend)
```

### Arquivos Compartilhados (CUIDADO!)

**‚ö†Ô∏è Conflito Potencial:**
```
packages/shared/src/types/           # Todos criam types
packages/database/prisma/schema.prisma  # Migrations
apps/api/src/app.module.ts          # Registrar novos modules
```

**Solu√ß√£o:**
- **Types:** Cada track cria em namespace pr√≥prio
  - `packages/shared/src/types/drivers/`
  - `packages/shared/src/types/webhooks/`
  - `packages/shared/src/types/onboarding/`
- **Prisma:** Migrations j√° aplicadas na Fase 0
- **app.module.ts:** Merge manual cuidadoso (imports simples)

---

## üìä CRONOGRAMA VISUAL

```
Semana ‚îÇ Person A (Track 1)        ‚îÇ Person B (Track 2)        ‚îÇ Person C (Track 3)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  1-2  ‚îÇ Interface + SES Refactor ‚îÇ Parsers DSN/ARF          ‚îÇ DKIM Generator
       ‚îÇ ‚úÖ Checkpoint: SES novo   ‚îÇ                          ‚îÇ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  3-4  ‚îÇ Postal SMTP Driver       ‚îÇ Webhooks Postal          ‚îÇ DNS Verification
       ‚îÇ ‚úÖ Checkpoint: Postal OK  ‚îÇ ‚úÖ Checkpoint: Webhooks  ‚îÇ ‚úÖ Checkpoint: DNS OK
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       ‚îÇ          üîÄ MERGE SPRINT 2 (Person A + B + C)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  5-6  ‚îÇ IP Pools + Rate Limit    ‚îÇ Supress√£o Avan√ßada       ‚îÇ Onboarding Checklist
       ‚îÇ ‚úÖ Checkpoint: Rate Limit ‚îÇ ‚úÖ Checkpoint: Suppression‚îÇ ‚úÖ Checkpoint: Checklist
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  7-8  ‚îÇ Providers + Fallback     ‚îÇ Reputa√ß√£o + Guardrails   ‚îÇ Dashboard Reputa√ß√£o
       ‚îÇ ‚úÖ Checkpoint: Multi-prov ‚îÇ ‚úÖ Checkpoint: Guardrails‚îÇ ‚úÖ Checkpoint: Dashboard
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       ‚îÇ          üîÄ BIG MERGE SPRINT 4 (Integra√ß√£o Total)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  9-10 ‚îÇ Drivers Adicionais       ‚îÇ Tracking Opens/Clicks    ‚îÇ DNS Records Manager
       ‚îÇ (Postal API, Mailu, etc) ‚îÇ ‚úÖ Checkpoint: Tracking  ‚îÇ ‚úÖ Checkpoint: DNS UI
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  11   ‚îÇ Testes + Docs            ‚îÇ Warm-up Scheduler        ‚îÇ Postmaster Ingest (opt)
       ‚îÇ                          ‚îÇ ‚úÖ Checkpoint: Warmup    ‚îÇ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  12   ‚îÇ          üöÄ DEPLOY STAGING + PRODU√á√ÉO
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
```

---

## üìä 7. ESTIMATIVA DE ESFOR√áO - MODELO PARALELO

### Modelo Sequencial (1 pessoa)
| Fase | Dura√ß√£o | Complexidade | Prioridade |
|------|---------|--------------|------------|
| 0. Prepara√ß√£o | 1 semana | Baixa | Alta |
| 1. Abstra√ß√£o SES | 2 semanas | Alta | **CR√çTICA** |
| 2. Driver Postal SMTP | 2 semanas | M√©dia | Alta |
| 3. Webhooks & Parsers | 2 semanas | Alta | Alta |
| 4. IP Pools & Rate Limiting | 2 semanas | Alta | Alta |
| 5. Supress√£o Avan√ßada | 1 semana | M√©dia | Alta |
| 6. Onboarding de Dom√≠nios | 3 semanas | Alta | Alta |
| 7. M√©tricas & Reputa√ß√£o | 2 semanas | Alta | Alta |
| 8. Warm-up Autom√°tico | 1 semana | M√©dia | M√©dia |
| 9. Tracking | 2 semanas | M√©dia | M√©dia |
| 10. Drivers Adicionais | 6 semanas | M√©dia | Baixa |
| 11. Postmaster Ingest | 2 semanas | Baixa | Baixa |
| 12. Testes & Deploy | 2 semanas | Alta | **CR√çTICA** |

**Total Sequencial:** 28-30 semanas (~6-7 meses) - 1 pessoa

---

### Modelo Paralelo (3 pessoas) ‚ö°
| Sprint | Semanas | Track 1 | Track 2 | Track 3 | Status |
|--------|---------|---------|---------|---------|--------|
| Sprint 0 | 1 | Prepara√ß√£o | Prepara√ß√£o | Prepara√ß√£o | Setup |
| Sprint 1 | 2 | Interface + SES | Parsers DSN/ARF | DKIM Gen | üîÄ Merge |
| Sprint 2 | 2 | Postal SMTP | Webhooks | DNS Verify | üîÄ Merge |
| Sprint 3 | 2 | IP Pools | Supress√£o | Onboarding | üîÄ Merge |
| Sprint 4 | 2 | Providers | Reputa√ß√£o | Dashboard | üîÄ **BIG MERGE** |
| Sprint 5 | 2 | Drivers Extras | Tracking | DNS UI | üîÄ Merge |
| Sprint 6 | 1 | Testes | Warm-up | Postmaster | üîÄ Final |
| Sprint 7 | 1 | Deploy | Deploy | Deploy | üöÄ Produ√ß√£o |

**Total Paralelo:** **12 semanas (~3 meses)** - 3 pessoas

**Ganho de Tempo:** 
- Sequencial: 28 semanas
- Paralelo: 12 semanas
- **Redu√ß√£o: 57% de tempo** üéØ

---

### Aloca√ß√£o de Recursos

#### Person A (Track 1) - Backend S√™nior
**Horas Estimadas:** 480h (12 semanas √ó 40h)
- Semana 1-2: Interface & SES (80h)
- Semana 3-4: Postal SMTP (80h)
- Semana 5-6: IP Pools & Rate Limit (80h)
- Semana 7-8: Providers & Fallback (80h)
- Semana 9-10: Drivers Adicionais (80h)
- Semana 11-12: Testes & Deploy (80h)

#### Person B (Track 2) - Backend Pleno/S√™nior
**Horas Estimadas:** 480h (12 semanas √ó 40h)
- Semana 1-2: Parsers DSN/ARF (80h)
- Semana 3-4: Webhooks Postal (80h)
- Semana 5-6: Supress√£o (80h)
- Semana 7-8: Reputa√ß√£o & Guardrails (80h)
- Semana 9-10: Tracking (80h)
- Semana 11-12: Warm-up & Deploy (80h)

#### Person C (Track 3) - Full-Stack
**Horas Estimadas:** 480h (12 semanas √ó 40h)
- Semana 1-2: DKIM Generator (80h)
- Semana 3-4: DNS Verification (80h)
- Semana 5-6: Onboarding Checklist (80h)
- Semana 7-8: Dashboard Reputa√ß√£o (80h)
- Semana 9-10: DNS UI (80h)
- Semana 11-12: Postmaster & Deploy (80h)

**Total Pessoa/Hora:** 1.440 horas  
**Custo Estimado (Brasil):** R$ 216.000 - R$ 360.000 (m√©dia R$ 150-250/h)

---

### MVP vs Completo

#### MVP Funcional (Sprint 1-4 ‚Üí 8 semanas)
**Entregas:**
- ‚úÖ AWS SES como toggle
- ‚úÖ Driver Postal SMTP
- ‚úÖ Webhooks (bounce, complaint, delivery)
- ‚úÖ IP Pools & Rate Limiting
- ‚úÖ Sistema de Supress√£o
- ‚úÖ Onboarding de Dom√≠nios (DKIM, SPF, DNS)
- ‚úÖ Reputa√ß√£o & Guardrails
- ‚úÖ Dashboard b√°sico

**Status:** **Sistema Produ√ß√£o-Ready** üöÄ

#### Fase 2 (Sprint 5-7 ‚Üí +4 semanas)
**Entregas:**
- ‚úÖ Drivers adicionais (Mailu, Haraka)
- ‚úÖ Tracking (opens/clicks)
- ‚úÖ Warm-up autom√°tico
- ‚úÖ Dashboard avan√ßado
- ‚úÖ Postmaster ingest (opcional)

**Status:** ESP Completo de N√≠vel Enterprise üèÜ

---

### Comparativo com Mercado

| Solu√ß√£o | Tempo | Custo | Features |
|---------|-------|-------|----------|
| **Nosso ESP** | 12 semanas | R$ 216-360k | 100% customizado |
| SendGrid Enterprise | - | $3.000-10.000/m√™s | Vendor lock-in |
| Mailgun | - | $800-3.000/m√™s | Limita√ß√µes API |
| AWS SES + Setup | 4 semanas | R$ 50k + uso | B√°sico |
| Postal Self-Hosted | 8 semanas | R$ 150k | Sem IP pools |

**ROI:** 
- Break-even em ~6 meses vs SendGrid Enterprise
- Controle total sobre infraestrutura
- Sem limites de API/volume

---

## üö® 8. RISCOS E MITIGA√á√ïES

### Risco 1: Perda de Emails Durante Migra√ß√£o
**Mitiga√ß√£o:**
- Implementar feature flags para rollback instant√¢neo
- Manter SES como fallback autom√°tico
- Testes extensivos em staging antes de produ√ß√£o

### Risco 2: Reputa√ß√£o de IP Baixa no In√≠cio
**Mitiga√ß√£o:**
- Warm-up autom√°tico obrigat√≥rio
- Come√ßar com volumes baixos
- Monitoramento 24/7 nos primeiros 30 dias

### Risco 3: Complexidade de DNS
**Mitiga√ß√£o:**
- Onboarding guiado com checklist visual
- Verifica√ß√£o autom√°tica em tempo real
- Suporte dedicado para clientes

### Risco 4: Rate Limiting Muito Agressivo
**Mitiga√ß√£o:**
- Configura√ß√µes ajust√°veis por cliente
- Retry inteligente com backoff
- Monitoramento de taxa de rejei√ß√£o

### Risco 5: Webhooks de Providers Diferentes
**Mitiga√ß√£o:**
- Parsers robustos para cada provider
- Testes com payloads reais
- Fallback para processamento manual

---

## üìù 9. VARI√ÅVEIS DE AMBIENTE NOVAS

```bash
# Provider Configuration
EMAIL_PROVIDER=AWS_SES                     # AWS_SES, POSTAL_SMTP, POSTAL_API, MAILU_SMTP, HARAKA_API
EMAIL_PROVIDER_FALLBACK=true              # Enable fallback to SES

# Postal Configuration
POSTAL_SMTP_HOST=postal.example.com
POSTAL_SMTP_PORT=25
POSTAL_SMTP_USER=gateway@example.com
POSTAL_SMTP_PASS=secret
POSTAL_API_KEY=api_key_here
POSTAL_WEBHOOK_SECRET=webhook_secret

# Mailu Configuration
MAILU_SMTP_HOST=mailu.example.com
MAILU_SMTP_PORT=587
MAILU_SMTP_USER=gateway@example.com
MAILU_SMTP_PASS=secret

# Haraka Configuration
HARAKA_API_URL=http://haraka.example.com
HARAKA_API_KEY=api_key_here

# IP Pools
IP_POOL_TRANSACTIONAL=192.168.1.10,192.168.1.11
IP_POOL_MARKETING=192.168.1.20,192.168.1.21

# Rate Limits
RATE_LIMIT_GMAIL_PER_SECOND=20
RATE_LIMIT_OUTLOOK_PER_SECOND=10
RATE_LIMIT_YAHOO_PER_SECOND=5
RATE_LIMIT_DEFAULT_PER_SECOND=1

# Tracking
TRACKING_DOMAIN=track.certshift.com
TRACKING_PIXEL_ENABLED=true
TRACKING_CLICKS_ENABLED=true

# Reputation Monitoring
REPUTATION_CHECK_INTERVAL=3600000         # 1 hora
REPUTATION_BOUNCE_THRESHOLD=0.02          # 2%
REPUTATION_COMPLAINT_THRESHOLD=0.001      # 0.1%
REPUTATION_AUTO_PAUSE=true

# Warm-up
WARMUP_ENABLED=true
WARMUP_START_VOLUME=50
WARMUP_DAILY_INCREASE=1.5                 # 50% de aumento por dia
WARMUP_MAX_DAYS=30

# Postmaster (Opcional)
GMAIL_POSTMASTER_ENABLED=false
GMAIL_POSTMASTER_DOMAIN=certshift.com
MS_SNDS_ENABLED=false
DMARC_RUA_EMAIL=dmarc@certshift.com
```

---

## üîß 10. CONFIGURA√á√ÉO DOCKER-COMPOSE

### Adicionar ao `docker-compose.yml`:

```yaml
services:
  # ... servi√ßos existentes ...
  
  # Postal MTA (Self-hosted ESP)
  postal:
    image: ghcr.io/postalserver/postal:latest
    container_name: postal
    ports:
      - "25:25"     # SMTP
      - "587:587"   # SMTP Submission
      - "5000:5000" # Web UI
    environment:
      - POSTAL_DB_HOST=postgres
      - POSTAL_DB_NAME=postal
      - POSTAL_DB_USER=postal
      - POSTAL_DB_PASS=postal_password
      - POSTAL_REDIS_HOST=redis
    volumes:
      - postal_data:/opt/postal
      - ./postal-config:/config
    depends_on:
      - postgres
      - redis
    networks:
      - email-gateway-network
  
  # DNS Verification Worker
  dns-verification-worker:
    build:
      context: ./apps/worker
      dockerfile: Dockerfile.dns-worker
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - redis
      - postgres
    networks:
      - email-gateway-network
  
  # Reputation Calculator Worker
  reputation-worker:
    build:
      context: ./apps/worker
      dockerfile: Dockerfile.reputation-worker
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - redis
      - postgres
    networks:
      - email-gateway-network

volumes:
  postal_data:
```

---

## üìö 11. DOCUMENTA√á√ÉO A CRIAR

- [ ] `docs/drivers/DRIVER-INTERFACE.md` - Interface base de drivers
- [ ] `docs/drivers/AWS-SES-DRIVER.md` - Documenta√ß√£o do driver SES
- [ ] `docs/drivers/POSTAL-DRIVER.md` - Documenta√ß√£o do driver Postal
- [ ] `docs/drivers/MAILU-DRIVER.md` - Documenta√ß√£o do driver Mailu
- [ ] `docs/drivers/HARAKA-DRIVER.md` - Documenta√ß√£o do driver Haraka
- [ ] `docs/webhooks/POSTAL-WEBHOOKS.md` - Webhook format Postal
- [ ] `docs/webhooks/DSN-PARSER.md` - DSN (RFC 3464) parsing
- [ ] `docs/webhooks/ARF-PARSER.md` - ARF (RFC 5965) parsing
- [ ] `docs/onboarding/DOMAIN-ONBOARDING.md` - Processo de onboarding
- [ ] `docs/onboarding/DKIM-GENERATION.md` - Gera√ß√£o de DKIM
- [ ] `docs/onboarding/DNS-VERIFICATION.md` - Verifica√ß√£o autom√°tica DNS
- [ ] `docs/reputation/GUARDRAILS.md` - Sistema de guardrails
- [ ] `docs/reputation/WARMUP.md` - Warm-up autom√°tico
- [ ] `docs/tracking/OPENS-CLICKS.md` - Sistema de tracking
- [ ] `docs/rate-limiting/MX-RATE-LIMITS.md` - Rate limits por MX
- [ ] `docs/ip-pools/IP-POOL-MANAGEMENT.md` - Gest√£o de IP pools
- [ ] `docs/suppression/SUPPRESSION-LISTS.md` - Listas de supress√£o
- [ ] `docs/migration/MIGRATION-GUIDE.md` - Guia de migra√ß√£o para clientes

---

## ‚úÖ 12. CHECKLIST DE VALIDA√á√ÉO

### Funcional
- [ ] Envio via AWS SES funciona (toggle ON)
- [ ] Envio via Postal SMTP funciona (toggle ON)
- [ ] Envio via Postal API funciona
- [ ] Fallback SES ‚Üí Postal funciona
- [ ] Bounces detectados e processados
- [ ] Complaints detectados e processados
- [ ] Suppressions aplicadas corretamente
- [ ] Rate limiting por MX funciona
- [ ] IP pools selecionados corretamente
- [ ] Return-Path dedicado gerado
- [ ] DKIM gerado e assinado
- [ ] DNS verificado automaticamente
- [ ] Warm-up respeitado
- [ ] Guardrails pausam envio quando necess√°rio
- [ ] Tracking de opens funciona
- [ ] Tracking de clicks funciona

### Performance
- [ ] Lat√™ncia de envio < 500ms
- [ ] Throughput de 1000+ emails/minuto
- [ ] Retry funciona sem perda de dados
- [ ] Queue n√£o acumula backlog
- [ ] Redis n√£o sobrecarrega
- [ ] PostgreSQL otimizado

### Seguran√ßa
- [ ] Chaves privadas DKIM encriptadas
- [ ] Webhooks validados (HMAC)
- [ ] Secrets em vault (n√£o em env)
- [ ] TLS em todas conex√µes SMTP
- [ ] API keys rotacionadas

### Observabilidade
- [ ] M√©tricas no Prometheus
- [ ] Logs estruturados
- [ ] Alertas configurados
- [ ] Dashboard funcionando
- [ ] Tracing habilitado

---

## üéâ 13. CONCLUS√ÉO

Este plano mapeia **todas as mudan√ßas necess√°rias** para transformar o `email-gateway` em um **ESP self-hosted completo** com todas as funcionalidades de um servi√ßo profissional de envio de emails.

### Principais Entreg√°veis

1. **Multi-Provider**: Suporte a AWS SES, Postal, Mailu, Haraka
2. **IP Pools**: Gest√£o de m√∫ltiplos IPs (transacional, marketing, dedicado)
3. **Rate Limiting**: Inteligente por MX (Gmail, Outlook, Yahoo)
4. **Webhooks**: Processamento completo de bounces, complaints, opens, clicks
5. **Supress√£o**: Sistema avan√ßado com listas globais e por tenant
6. **Onboarding**: Automa√ß√£o completa de DNS (DKIM, SPF, Return-Path)
7. **Reputa√ß√£o**: Monitoramento em tempo real com guardrails autom√°ticos
8. **Warm-up**: Escalamento gradual autom√°tico
9. **Tracking**: Opens e clicks com m√©tricas detalhadas
10. **Postmaster**: Ingest de dados de Gmail Postmaster e MS SNDS (opcional)

### Pr√≥ximos Passos

1. **Revisar** este documento com o time t√©cnico
2. **Aprovar** escopo e prioridades
3. **Iniciar Fase 0** (Prepara√ß√£o)
4. **Implementar Fase 1** (Abstra√ß√£o SES) - **CR√çTICO**
5. **Iterar** pelas fases seguintes

---

---

## üõ†Ô∏è COMANDOS √öTEIS POR TRACK

### Track 1 (Person A) - Comandos

```bash
# Setup inicial
git checkout -b track-1-drivers feature/esp-selfhosted
mkdir -p apps/worker/src/drivers/{base,aws-ses,postal,mailu,haraka}
mkdir -p apps/api/src/modules/{ip-pool,provider,rate-limit}

# Rodar worker isolado
cd apps/worker
npm run dev

# Testes
npm test -- drivers/
npm test -- services/email-driver.service

# Build
npm run build

# Testar envio SES
curl -X POST http://localhost:3000/v1/email/send \
  -H "X-API-Key: your-key" \
  -d '{"to":"test@example.com","subject":"Test","html":"<p>Test</p>"}'
```

### Track 2 (Person B) - Comandos

```bash
# Setup inicial
git checkout -b track-2-webhooks feature/esp-selfhosted
mkdir -p apps/worker/src/services
mkdir -p apps/api/src/modules/{webhook,suppression,tracking,reputation}

# Testar parsers
npm test -- services/dsn-parser
npm test -- services/arf-parser

# Simular webhook Postal
curl -X POST http://localhost:3000/webhooks/postal \
  -H "Content-Type: application/json" \
  -d @test-payloads/bounce.json

# Verificar supress√£o
curl http://localhost:3000/v1/suppressions?email=blocked@example.com

# Rodar worker de reputa√ß√£o
cd apps/worker
npm run worker:reputation
```

### Track 3 (Person C) - Comandos

```bash
# Setup inicial
git checkout -b track-3-domains feature/esp-selfhosted
mkdir -p apps/api/src/modules/onboarding
mkdir -p apps/dashboard/src/pages/{domains,reputation,metrics}

# Gerar DKIM
curl -X POST http://localhost:3000/v1/domains/:id/onboarding/generate-dkim

# Verificar DNS
curl http://localhost:3000/v1/domains/:id/onboarding/verify

# Rodar dashboard
cd apps/dashboard
npm run dev

# Build frontend
npm run build
```

---

## üìö REFER√äNCIAS T√âCNICAS

### RFCs Importantes
- **RFC 3464** - Delivery Status Notifications (DSN)
- **RFC 5965** - Abuse Reporting Format (ARF)
- **RFC 6376** - DomainKeys Identified Mail (DKIM)
- **RFC 7208** - Sender Policy Framework (SPF)
- **RFC 7489** - Domain-based Message Authentication (DMARC)

### Documenta√ß√£o de Providers
- **Postal**: https://docs.postalserver.io/
- **Mailu**: https://mailu.io/master/
- **Haraka**: https://haraka.github.io/
- **AWS SES**: https://docs.aws.amazon.com/ses/

### Ferramentas de Teste
- **DNS Checker**: https://dnschecker.org/
- **DKIM Validator**: https://dkimvalidator.com/
- **SPF Checker**: https://www.kitterman.com/spf/validate.html
- **MX Toolbox**: https://mxtoolbox.com/

### Rate Limits por Provider
| Provider | Per Second | Per Minute | Notes |
|----------|-----------|------------|-------|
| Gmail | 20 | 1,000 | Mais restritivo |
| Outlook | 10 | 500 | Moderado |
| Yahoo | 5 | 250 | Conservador |
| Default | 1 | 50 | Seguro |

---

## üéì LEARNING PATH SUGERIDO

### Week 0 - Prepara√ß√£o
- [ ] Ler documenta√ß√£o de drivers existente
- [ ] Estudar c√≥digo do `SESService` atual
- [ ] Entender fluxo: API ‚Üí Queue ‚Üí Worker ‚Üí SES
- [ ] Configurar ambiente local

### Week 1-2 - Fundamentos
- [ ] **Track 1:** Entender padr√£o Factory e Strategy
- [ ] **Track 2:** Ler RFCs 3464 e 5965
- [ ] **Track 3:** Estudar DKIM e gera√ß√£o de chaves RSA

### Week 3-4 - Implementa√ß√£o Core
- [ ] Foco em testes unit√°rios
- [ ] Code review entre tracks
- [ ] Primeira integra√ß√£o (Sprint 2)

### Week 5-8 - Features Avan√ßadas
- [ ] Integra√ß√£o cont√≠nua
- [ ] Testes de carga
- [ ] Performance tuning

### Week 9-12 - Finaliza√ß√£o
- [ ] Testes end-to-end
- [ ] Documenta√ß√£o
- [ ] Deploy staging ‚Üí produ√ß√£o

---

## üìû COMUNICA√á√ÉO ENTRE TRACKS

### Daily Sync (15 min)
**Hor√°rio:** 10:00 AM (di√°rio)  
**Formato:** Cada pessoa responde:
1. O que fiz ontem?
2. O que vou fazer hoje?
3. Algum bloqueio?
4. Preciso de ajuda de outro track?

### Sprint Planning (2h)
**Frequ√™ncia:** A cada 2 semanas  
**Objetivo:** Planejar pr√≥ximo sprint  
**Participantes:** Todos + Tech Lead

### Sprint Review (1h)
**Frequ√™ncia:** Final de cada sprint  
**Objetivo:** Demo + feedback  
**Participantes:** Todos + stakeholders

### Merge Review (30min)
**Frequ√™ncia:** Antes de cada merge point  
**Objetivo:** Validar integra√ß√£o  
**Participantes:** Todos

### Canais de Comunica√ß√£o
- **Slack #esp-selfhosted**: D√∫vidas gerais
- **Slack #esp-track-1**: Person A
- **Slack #esp-track-2**: Person B
- **Slack #esp-track-3**: Person C
- **GitHub PRs**: Code review
- **Notion/Docs**: Documenta√ß√£o

---

## ‚ö†Ô∏è REGRAS DE OURO

### ‚úÖ SEMPRE
1. **Testar** antes de fazer PR
2. **Documentar** decis√µes importantes
3. **Comunicar** bloqueios imediatamente
4. **Code review** antes de merge
5. **Backup** antes de migrations
6. **Feature flags** para rollback f√°cil

### ‚ùå NUNCA
1. **Commitar** c√≥digo que quebra build
2. **Merge** sem aprova√ß√£o de 2 pessoas
3. **Deploy** sem testes
4. **Modificar** arquivos de outro track sem avisar
5. **Deletar** migrations antigas
6. **Hard-code** credenciais

---

**Documento preparado por:** An√°lise T√©cnica Completa  
**Data:** 30 de Outubro de 2025  
**Vers√£o:** 2.0 - 3 Tracks Paralelas  
**Status:** üìã Pronto para Execu√ß√£o

---

### Anexos

- **Diagramas de Arquitetura**: `docs/architecture/ESP-ARCHITECTURE.md` (a criar)
- **ERD do Banco de Dados**: `docs/database/ESP-ERD.md` (a criar)
- **Fluxogramas**: `docs/flows/ESP-FLOWS.md` (a criar)
- **Guide Person A**: `docs/tracks/TRACK-1-GUIDE.md` (a criar)
- **Guide Person B**: `docs/tracks/TRACK-2-GUIDE.md` (a criar)
- **Guide Person C**: `docs/tracks/TRACK-3-GUIDE.md` (a criar)

